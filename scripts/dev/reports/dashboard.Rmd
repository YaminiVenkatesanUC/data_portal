---
title: "COVID-19 data portal -- monthly report"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
---

```{r setup, include=FALSE}
library(flexdashboard)
library(ggplot2)
library(plotly)
library(wordcloud2)
#library(shiny)
setwd("~/data_portal")
source("scripts/dev/reports/report.R")
```

Performance
========================================

Row
-----------------------------------------
### Total number of indicators

```{r}
totalInd <- df_events$ind_count_cum[length(df_events$ind_count_cum)]
valueBox(value = paste0(totalInd), color = "primary")
```


### Change in visits
```{r}
latest_views <- df_events$views_count[df_events$month == latest_report_date]
previous_views <- df_events$views_count[df_events$month == latest_report_date %m-% months(1)]
perc_change <- round(latest_views / previous_views * 100 - 100, 1)
valueBox(value = paste0(perc_change, "%"), 
         color = ifelse(previous_views > latest_views, "warning", "primary"), 
         icon = ifelse(previous_views > latest_views, "fa-angle-double-down", "fa-angle-double-up"))
```

### Percent downloaded
```{r}
perc_downloaded <- round(df_events$download_count[df_events$month == latest_report_date] / df_events$views_count[df_events$month == latest_report_date] * 100, 1)
valueBox(value = paste0(perc_downloaded, "%"), caption = "of visits ended in download", color = "primary")
```

Row
-----------------------------------------

### Frequency
```{r}

data <- df_indicators %>% 
  group_by(frequency) %>% 
  summarise(count = n())
  
  
fig <- data %>% plot_ly(labels = ~frequency, values = ~count)
fig <- fig %>% add_pie(hole = 0.6)
fig <- fig %>% layout(title = "Number of indicators by frequency",  showlegend = F,
                      xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
                      yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig
```

### Sub-series
```{r}
```

### Downloadable
```{r}
```

### International
```{r}
```

Row
------------------------------------------

### Loaded into Open Data API
```{r}
opi <- 60
gauge(opi, min = 0, max = totalInd, gaugeSectors(
  success = c(80, 180), warning = c(40, 79), danger = c(0, 39)
))
```

### Automated updates
```{r}
automated <- 40
gauge(automated, min = 0, max = totalInd, gaugeSectors(
  success = c(80, 180), warning = c(40, 79), danger = c(0, 39)
))
```

Summary
============================================================

Row {data-height = 650}
-----------------------------------------------------------------------
### Most popular indicators
Bla-bla-bla
```{r}
ind_views_total <- df_ind_views %>% 
  select(indicator_name, ind_views) %>% 
  group_by(indicator_name) %>% 
  summarise(count = sum(ind_views)) %>%
  arrange(count)

ind_views_total <- df_indicators %>% 
  select(indicator_name) %>% 
  unique() %>% 
  left_join(ind_views_total) %>% 
  arrange(count)

ind_views_total$count <- ifelse(is.na(ind_views_total$count), 1, ind_views_total$count)

col_vec <- rep(c("#9fb4ff", "#5976b4", "#070058", "#bfbfbf", "#002b74"), 5)
#hwordcloud(text = ind_views_total$indicator_name, size = ind_views_total$count, width = "100%", )
fig <- wordcloud2(data = tail(ind_views_total, 25), size = 0.4,minRotation = 0, maxRotation = 0, color = col_vec)
fig
```

### Least visited indicators

```{r}
col_vec2 <- rep(c("#FFBABA", "#FF7B7B", "#FF5252", "#FF0000", "#A70000"), 5)
#hwordcloud(text = ind_views_total$indicator_name, size = ind_views_total$count, width = "100%", )
cloud2 <- wordcloud2(data = head(ind_views_total, 25), size = 0.4,minRotation = 0, maxRotation = 0, color = col_vec2)
cloud2
```


Row {data-height = 350}
-----------------------------------------------------------------------

### Number of indicators

```{r}
y_vis<- list(
  tickfont = list(color = "red"),
  overlaying = "y",
  side = "right",
  title = "Montly visits"
)

fig1 <- plot_ly(
  x = df_events$month,
  y = df_events$ind_count_cum,
  type = "bar",
  name = "Number of indicators"
)

fig1 <- fig1 %>% add_lines(x = df_events$month, y = df_events$views_count, name = "Monthly visits", yaxis = "y2")
fig1 <- fig1 %>% add_lines(x = df_events$month, y = df_events$download_count, name = "Monthly downloads", yaxis = "y2")
fig1 <- fig1 %>% layout(title = "Number of indicators overlayed wth monthly visits",
                        yaxis2 = y_vis,
                        xaxis = list(title = "Month"))

fig1

```

Indicators
======================================================================

Row {data-height = 650}
-----------------------------------------------------------------------

### Indicator

